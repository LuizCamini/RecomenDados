CREATE
OR ALTER VIEW VW_OperacionalDocumentos AS
SELECT DISTINCT DOC.FILIALID AS FILIALORIGEMID
     , DOC.DOCID AS DOCUMENTOID
     , DOC.NUMERODOC AS NUMERODOCUMENTO
     , DOC.SERIE AS SERIE
     , FORMAT(DOC.DATAEMISSAO,'dd/MM/yyyy','PT-BR') AS DATAEMISSAO
     , DOC.LOCALENTREGACIDADE AS LOCALENTREGACIDADE
     , DOC.LOCALENTREGAUF AS LOCALENTREGAUF
     , doc.DataCadastro AS DataCadastro
     , FILORIGEM.SIGLA AS FILIALORIGEMSIGLA
     , doc.TipoDocumentoId AS TipoDocumentoId
     , CASE WHEN TIPODOC.IDENTIFICADOR = 'C' THEN 'Conhecimento (CT-e)'
            WHEN TIPODOC.IDENTIFICADOR = 'M' THEN 'Minuta (MD-e)'
       END AS TIPODOCUMENTOIDENTIFICADOR
     , doc.StatusDocumentoId AS StatusDocumentoId
     , STDOCUMENTO.DESCRICAO AS STATUSDOCUMENTODESCRICAO
     , STDOCUMENTO.SIGLA AS STATUSDOCUMENTOSIGLA
     , DOC.PRODUTOID AS PRODUTOID
     , COMPFRETE.VALORMERCADORIA AS VALORMERCADORIA
     , COMPFRETE.PESO AS PESO
     , COMPFRETE.PESOCUBADO AS PESOCUBADO
     , COMPFRETE.TOTALFRETE AS TOTALFRETE
     , DOC.REMETENTEID AS REMETENTEID
     , CLIREM.CPFCNPJ AS REMETENTECPFCNPJ
     , CLIREM.NOMEFANTASIA AS REMETENTENOMEFANTASIA
     , DOC.DESTINATARIOID AS DESTINATARIOID
     , CLIDEST.CPFCNPJ AS DESTINATARIOCPFCNPJ
     , CLIDEST.NOMEFANTASIA AS DESTINATARIONOMEFANTASIA
     , doc.ExpedidorId AS ExpedidorId
     , doc.RecebedorId AS RecebedorId
     , doc.RedespachoId AS RedespachoId
     , DOC.TOMADORID AS TOMADORID
     , doc.TipoFreteId AS TipoFreteId
     , TPFRETE.TIPOFRETEDESC AS TIPOFRETEDESC
     , (SELECT TOP 1 NUMERONOTA
          FROM DOCUMENTONOTA DN1
         WHERE DN1.DOCID = DOC.DOCID
           AND DN1.CLIENTEID = DOC.REMETENTEID
       ) AS NUMERONOTAFISCAL
     , (SELECT SUM(VOLUMES)
          FROM DOCUMENTONOTA DN
         WHERE DN.DOCID = DOC.DOCID
           AND DN.CLIENTEID = DOC.REMETENTEID
       ) AS VOLUMES
  FROM DOCUMENTOS DOC INNER JOIN
       DOCDESTINATARIO CLIDEST ON CLIDEST.DOCID = DOC.DOCID
   AND CLIDEST.CLIENTEID = DOC.DESTINATARIOID INNER JOIN
       DOCREMETENTE CLIREM ON CLIREM.DOCID = DOC.DOCID
   AND CLIREM.CLIENTEID = DOC.REMETENTEID INNER JOIN
       DOCUMENTOSCOMPOSICAOFRETE COMPFRETE ON COMPFRETE.DOCID = DOC.DOCID INNER JOIN
       SITRAWEBNEW.DBO.FILIAIS FILORIGEM ON FILORIGEM.FILIALID = DOC.FILIALID INNER JOIN
       SITRAWEBNEW.DBO.TIPODOCUMENTO TIPODOC ON TIPODOC.TIPODOCUMENTOID = DOC.TIPODOCUMENTOID INNER JOIN
       SITRAWEBNEW.DBO.STATUSDOCUMENTO STDOCUMENTO ON STDOCUMENTO.STATUSDOCUMENTOID = DOC.STATUSDOCUMENTOID LEFT JOIN
       SITRAWEBNEW.DBO.STATUSDOCUMENTOSEFAZ STDOCUMENTOSEFAZ ON STDOCUMENTOSEFAZ.STATUSDOCUMENTOSEFAZID = DOC.STATUSDOCUMENTOSEFAZID INNER JOIN
       SITRAWEBNEW.DBO.TIPOFRETE TPFRETE ON TPFRETE.TIPOFRETEID = DOC.TIPOFRETEID INNER JOIN
       DOCUMENTONOTA DOCNOTA ON DOC.DOCID = DOCNOTA.DOCID
   AND DOCNOTA.CLIENTEID = DOC.REMETENTEID
 WHERE(DOC.NUMEROTEMPORARIO IS NULL)
   AND((DOC.TIPODOCUMENTOID = 1
            AND DOC.STATUSDOCUMENTOSEFAZID IS NOT NULL
            AND DOC.STATUSDOCUMENTOSEFAZID NOT IN (1,2,3,4,6,7,8,10)) OR DOC.TIPODOCUMENTOID = 5);

